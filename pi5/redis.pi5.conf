# ─── Redis 7 — Raspberry Pi 5 Optimized Configuration ─────────────────────────
# Target: BCM2712 / Cortex-A76, 16GB LPDDR4X
# Role: BullMQ queue broker + NATT rate-limit counters

# ── Network ────────────────────────────────────────────────────────────────────
bind 127.0.0.1 ::1          # Loopback only — do NOT expose to network
port 6379
protected-mode yes
tcp-backlog 1024
timeout 300
tcp-keepalive 60

# ── Authentication ─────────────────────────────────────────────────────────────
# Set a strong password in production — uncomment and set:
# requirepass YOUR_REDIS_PASSWORD
# Also set in DevBot .env: REDIS_URL=redis://:PASSWORD@127.0.0.1:6379

# ── Memory ─────────────────────────────────────────────────────────────────────
# BullMQ queues + NATT rate limit counters — cap at 512MB on 16GB board
maxmemory 512mb
maxmemory-policy allkeys-lru  # Evict LRU keys when full (BullMQ-safe for non-critical data)
maxmemory-samples 10
active-expire-enabled yes

# ── Persistence ────────────────────────────────────────────────────────────────
# On NVMe, AOF is safe. On SD card, use RDB only.
dir /mnt/nvme/docker/redis   # NVMe-backed data directory

# RDB snapshots (fallback)
save 900  1      # After 900s if ≥1 key changed
save 300  10
save 60   10000

# AOF (preferred — lower data loss window)
appendonly yes
appendfilename "appendonly.aof"
appenddirname "appendonlydir"
appendfsync everysec          # fsync every second — good balance on NVMe
no-appendfsync-on-rewrite yes # Avoid fsync stall during REWRITE on Pi
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# ── Persistence tuning for Pi ARM ─────────────────────────────────────────────
hz 15                         # Background task frequency (default 10)
dynamic-hz yes
aof-use-rdb-preamble yes      # Hybrid persistence — faster load

# ── Lazy freeing (reduces latency spikes on ARM) ───────────────────────────────
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

# ── BullMQ-specific tuning ─────────────────────────────────────────────────────
# BullMQ uses Lua scripts and pub/sub — these settings improve throughput
list-max-listpack-size -2     # 8kb per listpack node
list-compress-depth 1

# ── Keyspace notifications (BullMQ uses these for job events) ──────────────────
notify-keyspace-events "Ex"   # Expired events — enables delayed job processing

# ── Clients ────────────────────────────────────────────────────────────────────
maxclients 128                # Conservative for Pi shared workload
client-query-buffer-limit 2mb
proto-max-bulk-len 64mb

# ── Logging ────────────────────────────────────────────────────────────────────
loglevel notice
logfile /mnt/nvme/logs/devbot/redis.log

# ── THP (Transparent Huge Pages) warning suppression ──────────────────────────
# Run on Pi OS: echo never > /sys/kernel/mm/transparent_hugepage/enabled
# and add to /etc/rc.local

# ── Slow log ───────────────────────────────────────────────────────────────────
slowlog-log-slower-than 5000  # Log commands taking > 5ms
slowlog-max-len 128
