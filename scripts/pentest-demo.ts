#!/usr/bin/env tsx
/**
 * DevBot Pentest Demo Script
 * 
 * Quick testing script for pentest capabilities without needing Slack/Discord
 * 
 * Usage:
 *   npx tsx scripts/pentest-demo.ts [target] [scan-type]
 * 
 * Examples:
 *   npx tsx scripts/pentest-demo.ts freakme.fun
 *   npx tsx scripts/pentest-demo.ts freakme.fun web-security
 *   npx tsx scripts/pentest-demo.ts . secret-scan
 */

import { runPentestScan, formatReportForSlack } from "../src/services/pentest";

const args = process.argv.slice(2);
const target = args[0] || "freakme.fun";
const scanType = (args[1] || "web-security") as "full" | "dependency-audit" | "secret-scan" | "web-security" | "port-scan";

console.log(`ğŸ”’ DevBot Pentest Demo\n`);
console.log(`Target: ${target}`);
console.log(`Scan Type: ${scanType}\n`);

const validScanTypes = ["full", "dependency-audit", "secret-scan", "web-security", "port-scan"];
if (!validScanTypes.includes(scanType)) {
  console.error(`âŒ Invalid scan type: ${scanType}`);
  console.error(`Valid types: ${validScanTypes.join(", ")}`);
  process.exit(1);
}

console.log(`â³ Running scan...\n`);

runPentestScan(target, scanType, {
  authorized: true,
  repoPath: scanType === "dependency-audit" || scanType === "secret-scan" ? process.cwd() : undefined,
})
  .then((report) => {
    console.log(`âœ… Scan complete!\n`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);

    const emoji = {
      critical: "ğŸ”´",
      high: "ğŸŸ ",
      medium: "ğŸŸ¡",
      low: "ğŸŸ¢",
      clean: "âœ…",
    }[report.summary.riskRating];

    console.log(`${emoji} SECURITY SCAN REPORT`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);

    console.log(`Target:       ${report.target}`);
    console.log(`Scan Type:    ${report.scanType}`);
    console.log(`Scan ID:      ${report.scanId}`);
    console.log(`Started:      ${report.startedAt.toISOString()}`);
    console.log(`Completed:    ${report.completedAt.toISOString()}`);
    console.log(`Duration:     ${Math.round((report.completedAt.getTime() - report.startedAt.getTime()) / 1000)}s\n`);

    console.log(`RISK ASSESSMENT`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log(`Risk Rating:  ${emoji} ${report.summary.riskRating.toUpperCase()}`);
    console.log(`Risk Score:   ${report.summary.riskScore}/100\n`);

    console.log(`FINDINGS SUMMARY`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log(`ğŸ”´ Critical:  ${report.summary.criticalCount}`);
    console.log(`ğŸŸ  High:      ${report.summary.highCount}`);
    console.log(`ğŸŸ¡ Medium:    ${report.summary.mediumCount}`);
    console.log(`ğŸŸ¢ Low:       ${report.summary.lowCount}`);
    console.log(`â„¹ï¸  Info:      ${report.summary.infoCount}`);
    console.log(`ğŸ“Š Total:     ${report.summary.totalFindings}\n`);

    if (report.summary.topRecommendation) {
      console.log(`TOP RECOMMENDATION`);
      console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
      console.log(`${report.summary.topRecommendation}\n`);
    }

    if (report.findings.length > 0) {
      console.log(`DETAILED FINDINGS`);
      console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);

      const maxDisplay = 10;
      report.findings.slice(0, maxDisplay).forEach((finding, idx) => {
        const severityEmoji = {
          critical: "ğŸ”´",
          high: "ğŸŸ ",
          medium: "ğŸŸ¡",
          low: "ğŸŸ¢",
          info: "â„¹ï¸",
        }[finding.severity];

        console.log(`${idx + 1}. ${severityEmoji} ${finding.title}`);
        console.log(`   Category: ${finding.category}`);
        console.log(`   Severity: ${finding.severity.toUpperCase()}`);
        if (finding.cve) console.log(`   CVE: ${finding.cve}`);
        console.log(`   Description: ${finding.description.slice(0, 200)}${finding.description.length > 200 ? '...' : ''}`);
        if (finding.remediation) {
          console.log(`   Remediation: ${finding.remediation.slice(0, 150)}${finding.remediation.length > 150 ? '...' : ''}`);
        }
        console.log();
      });

      if (report.findings.length > maxDisplay) {
        console.log(`... and ${report.findings.length - maxDisplay} more findings\n`);
      }
    }

    console.log(`AI ANALYSIS`);
    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
    console.log(report.aiAnalysis);
    console.log();

    console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`);
    console.log(`ğŸ’¡ TIP: Use /pentest in Slack or !pentest in Discord for automated scans\n`);
  })
  .catch((error) => {
    console.error(`âŒ Scan failed:`, error);
    process.exit(1);
  });
